/* global MLSearchController */
(function () {
  'use strict';

  angular.module('app.search')
    .controller('SearchCtrl', SearchCtrl);

  SearchCtrl.$inject = ['$scope', '$location', 'userService', 'MLSearchFactory'];

  // inherit from MLSearchController
  var superCtrl = MLSearchController.prototype;
  SearchCtrl.prototype = Object.create(superCtrl);

  function SearchCtrl($scope, $location, userService, searchFactory) {
    var ctrl = this;
    ctrl.runMapSearch = false;

    var mlSearch = searchFactory.newContext({queryOptions: 'all'});

    ctrl.myFacets = {};

    superCtrl.constructor.call(ctrl, $scope, $location, mlSearch);

    ctrl.init();

    ctrl.updateSearchResults = function (data) {
      superCtrl.updateSearchResults.apply(ctrl, arguments);
      ctrl.myFacets.facets = data.facets;
    };

    ctrl.setSnippet = function(type) {
      mlSearch.setSnippet(type);
      ctrl.search();
    };

    ctrl.search = function(qtext) {
      // console.log('in search override');
      if ( arguments.length ) {
        this.qtext = qtext;
      }

      this.mlSearch.setText( this.qtext ).setPage( this.page );

      if (ctrl.runMapSearch) {
        mlSearch.additionalQueries = [];
        mlSearch.additionalQueries.push(ctrl.getGeoConstraint());
      }

      return this._search();
    };

    ctrl.mapBoundsChanged = function(bounds) {
      ctrl.bounds = bounds;
      ctrl.search();
    };

    ctrl.mapOptions = {
      center: [-97.846, 38.591],
      zoom: 4,
      baseMap: 'national-geographic'
    };

    ctrl.bounds = {
      'south': 30.0,
      'west': -100.0,
      'north': 45.0,
      'east': -50.0
    };

    ctrl.getGeoConstraint = function() {
      return {
        'custom-constraint-query': {
          'constraint-name': 'geo-point',
          'box': [ ctrl.bounds ]
        }
      };
    };

    ctrl.toggleMapSearch = function (){
      if(ctrl.runMapSearch) {
        mlSearch.additionalQueries.push(ctrl.getGeoConstraint());
      }
      else {
        mlSearch.additionalQueries.pop(ctrl.getGeoConstraint());
      }
      this._search();
    };

    $scope.$watch(userService.currentUser, function(newValue) {
      ctrl.currentUser = newValue;
    });
  }
}());
